<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>政府の負担する消費税概算アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/dom-to-image"></script>
</head>
<body class="min-h-screen bg-white text-gray-900">
  <div class="max-w-4xl mx-auto p-6 md:p-8">
    <header class="flex flex-col gap-3 my-3 mb-6">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-xl grid place-items-center bg-gray-300 text-gray-800" aria-hidden="true">📊</div>
        <div>
          <h1 class="m-0 text-2xl md:text-3xl font-extrabold text-gray-900">政府の負担する消費税 概算アプリ</h1>
        </div>
      </div>
    </header>

    <section class="mb-4 bg-gray-100 border border-gray-300 rounded-2xl p-5 shadow-sm" aria-labelledby="input-title">
      <h2 id="input-title" class="m-0 mb-3 text-lg font-semibold text-gray-800">入力</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 text-sm bg-white">
          <thead class="bg-gray-200 text-gray-700">
            <tr>
              <th class="border border-gray-300 px-3 py-2 text-left">項目</th>
              <th class="border border-gray-300 px-3 py-2 text-left">入力</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-300 px-3 py-2">団体名</td>
              <td class="border border-gray-300 px-3 py-2"><input id="org" type="text" class="border border-gray-300 rounded-lg px-2 py-1 text-sm w-48" placeholder="例：品川区" /></td>
            </tr>
            <tr>
              <td class="border border-gray-300 px-3 py-2">年度</td>
              <td class="border border-gray-300 px-3 py-2"><input id="fiscalYear" type="text" class="border border-gray-300 rounded-lg px-2 py-1 text-sm w-24" placeholder="例：2025" />年度</td>
            </tr>
            <tr>
              <td class="border border-gray-300 px-3 py-2">歳出額総額（一般会計等）</td>
              <td class="border border-gray-300 px-3 py-2"><div class="flex items-center gap-2"><span class="opacity-70 text-gray-500">¥</span><input id="total" inputmode="numeric" autocomplete="off" class="flex-1 bg-transparent border border-gray-300 rounded-lg px-2 py-1 outline-none text-gray-900" /></div></td>
            </tr>
            <tr>
              <td class="border border-gray-300 px-3 py-2">人件費</td>
              <td class="border border-gray-300 px-3 py-2"><div class="flex items-center gap-2"><span class="opacity-70 text-gray-500">¥</span><input id="personnel" inputmode="numeric" autocomplete="off" class="flex-1 bg-transparent border border-gray-300 rounded-lg px-2 py-1 outline-none text-gray-900" /></div></td>
            </tr>
            <tr>
              <td class="border border-gray-300 px-3 py-2">公債費（元利償還）</td>
              <td class="border border-gray-300 px-3 py-2"><div class="flex items-center gap-2"><span class="opacity-70 text-gray-500">¥</span><input id="debt" inputmode="numeric" autocomplete="off" class="flex-1 bg-transparent border border-gray-300 rounded-lg px-2 py-1 outline-none text-gray-900" /></div></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="flex flex-wrap gap-3 mt-4">
        <button id="demo" type="button" class="inline-flex items-center gap-2 rounded-xl bg-gray-800 text-white font-bold px-4 py-2 shadow hover:bg-gray-700 transition">サンプル値を入れる</button>
        <button id="clear" type="button" class="inline-flex items-center gap-2 rounded-xl bg-white text-gray-800 border border-gray-400 px-4 py-2 hover:bg-gray-100">クリア</button>
        <button id="generateImg" type="button" class="inline-flex items-center gap-2 rounded-xl bg-blue-500 text-white font-bold px-4 py-2 shadow hover:bg-blue-400 transition">画像を作る</button>
      </div>
    </section>

    <section id="result-area" class="bg-gray-100 border border-gray-300 rounded-2xl p-5 shadow-sm" aria-labelledby="result-title">
      <div class="flex items-center justify-between mb-3">
        <h2 id="result-title" class="m-0 text-lg font-semibold text-gray-800">結果</h2>
        <div class="text-sm text-gray-600"><span id="display-org">団体名：</span>／<span id="display-year">年度：</span></div>
      </div>

      <div id="msg" class="text-xs text-gray-500 mb-3">数値を入力すると結果が表示されます。</div>

      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 text-sm">
          <thead class="bg-gray-200 text-gray-700">
            <tr>
              <th class="border border-gray-300 px-3 py-2 text-left">項目</th>
              <th class="border border-gray-300 px-3 py-2 text-right" hidden>金額</th>
              <th class="border border-gray-300 px-3 py-2 text-right">金額</th>
            </tr>
          </thead>
          <tbody class="bg-white">
            <tr>
              <td class="border border-gray-300 px-3 py-2">歳出額総額</td>
              <td hidden id="show-total" class="border border-gray-300 px-3 py-2 text-right font-bold">—</td>
              <td id="kanji-total" class="border border-gray-300 px-3 py-2 text-right text-gray-600">—</td>
            </tr>
            <tr>
              <td class="border border-gray-300 px-3 py-2">人件費</td>
              <td hidden id="show-personnel" class="border border-gray-300 px-3 py-2 text-right font-bold">—</td>
              <td id="kanji-personnel" class="border border-gray-300 px-3 py-2 text-right text-gray-600">—</td>
            </tr>
            <tr>
              <td class="border border-gray-300 px-3 py-2">公債費</td>
              <td hidden id="show-debt" class="border border-gray-300 px-3 py-2 text-right font-bold">—</td>
              <td id="kanji-debt" class="border border-gray-300 px-3 py-2 text-right text-gray-600">—</td>
            </tr>
            <tr class="bg-gray-50 font-semibold">
              <td class="border border-gray-300 px-3 py-2">消費税課税対象額（概算）</td>
              <td hidden id="policy" class="border border-gray-300 px-3 py-2 text-right font-bold">—</td>
              <td id="kanji-policy" class="border border-gray-300 px-3 py-2 text-right text-gray-600">—</td>
            </tr>
            <tr class="bg-gray-100">
              <td class="border border-gray-300 px-3 py-2">消費税負担額（概算）</td>
              <td hidden id="alt" class="border border-gray-300 px-3 py-2 text-right font-bold">—</td>
              <td id="kanji-alt" class="border border-gray-300 px-3 py-2 text-right text-gray-600">—</td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="mt-3 text-xs text-gray-500">※ 上の「税相当額」は参考計算です。ご提示の式とは異なります。</p>

      <section class="mt-3">
        <h3 class="text-sm font-semibold text-gray-800">式の確認</h3>
        <p class="text-xs text-gray-600">計算式：<span class="font-mono bg-gray-50 border border-gray-300 px-2 py-1 rounded-md text-gray-800">(歳出額総額 − (人件費 + 公債費)) − (1 − (1 / 1.1))</span></p>
      </section>
    </section>

  </div>

  <script>
    const fmtJPY = (n)=> isFinite(n) ? new Intl.NumberFormat('ja-JP', { style:'currency', currency:'JPY', maximumFractionDigits:0}).format(Math.floor(n)) : '—';
    const parseNum = (v)=> Number(String(v).replace(/[\,\s]/g,'').trim()) || 0;

    const numToKanji = (num)=>{
      if (!isFinite(num) || num <= 0) return '—';
      const units = ['', '万', '億', '兆'];
      let result = '';
      let unitIndex = 0;
      while(num > 0 && unitIndex < units.length){
        const part = num % 10000;
        if(part > 0) result = part + units[unitIndex] + result;
        num = Math.floor(num / 10000);
        unitIndex++;
      }
      return result + '円';
    };

    const $ = (id)=> document.getElementById(id);
    const els = { org: $('org'), fiscalYear: $('fiscalYear'), displayOrg: $('display-org'), displayYear: $('display-year'), total: $('total'), personnel: $('personnel'), debt: $('debt'), showTotal: $('show-total'), showPersonnel: $('show-personnel'), showDebt: $('show-debt'), policy: $('policy'), alt: $('alt'), msg: $('msg'), kanjiTotal: $('kanji-total'), kanjiPersonnel: $('kanji-personnel'), kanjiDebt: $('kanji-debt'), kanjiPolicy: $('kanji-policy'), kanjiAlt: $('kanji-alt') };

    const K = 1 - 1/1.1;

    const update = ()=>{
      const total = parseNum(els.total.value);
      const personnel = parseNum(els.personnel.value);
      const debt = parseNum(els.debt.value);

      els.showTotal.textContent = isFinite(total) && total>0 ? fmtJPY(total) : '—';
      els.showPersonnel.textContent = isFinite(personnel) && personnel>0 ? fmtJPY(personnel) : '—';
      els.showDebt.textContent = isFinite(debt) && debt>0 ? fmtJPY(debt) : '—';

      els.kanjiTotal.textContent = numToKanji(total);
      els.kanjiPersonnel.textContent = numToKanji(personnel);
      els.kanjiDebt.textContent = numToKanji(debt);

      const policy = total - (personnel + debt);
      els.policy.textContent = isFinite(policy) ? fmtJPY(policy) : '—';
      els.kanjiPolicy.textContent = numToKanji(policy);

      const alt = policy * K;
      els.alt.textContent = isFinite(alt) ? fmtJPY(alt) : '—';
      els.kanjiAlt.textContent = numToKanji(alt);

      els.displayOrg.textContent = els.org.value ? `団体名：${els.org.value}` : '団体名：—';
      els.displayYear.textContent = els.fiscalYear.value ? `年度：${els.fiscalYear.value}` : '年度：—';

      const allZero = [total, personnel, debt].every(v=>!v);
      els.msg.textContent = allZero ? '数値を入力すると結果が表示されます。' : '';

      [els.total, els.personnel, els.debt].forEach(input=>{
        const raw = input.value.replace(/,/g,'').trim();
        if(!raw) return;
        input.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        input.setSelectionRange(input.value.length, input.value.length);
      });
    };

    ['input','change'].forEach(ev=>{
      ['total','personnel','debt','org','fiscalYear'].forEach(id=>$(id).addEventListener(ev, update));
    });

    $('demo').addEventListener('click', ()=>{
      els.org.value = '品川区';
      els.fiscalYear.value = '2025';
      els.total.value = '120,000,000,000';
      els.personnel.value = '9,000,000,000';
      els.debt.value = '26,000,000,000';
      update();
    });

    $('clear').addEventListener('click', ()=>{
      ['org','fiscalYear','total','personnel','debt'].forEach(id=>$(id).value='');
      update();
    });

    $('generateImg').addEventListener('click', ()=>{
      const area = document.getElementById("result-area");
      domtoimage.toPng(area);
      const a = document.createElement("a");
      
      a.download = `${els.fiscalYear.value}年度-${els.org.value}の消費税負担額.png`
      domtoimage
        .toPng(area)
        .then((e) => {
          a.href = e;
          a.click();
        });
    });

    update();
  </script>
</body>
</html>
